
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storium Interactive</title>
</head>
<body>
    <!-- UI will be built dynamically by JS -->

        <script>
(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports) :
    typeof define === 'function' && define.amd ? define(['exports'], factory) :
    (global = typeof globalThis !== 'undefined' ? globalThis : global || self, factory(global.StoriumApp = {}));
})(this, function (exports) {
    'use strict';

    // Centralized style component for all app styles
    class StyleBody extends window.CssManagement.Component {
        constructor(registry) {
            super('app', registry);
            this.nl = registry.nullValue;
            // Define styles for all UI components
            this.styles = [
                'display', 'border-bottom', 'background', 'padding', 'gap',
                'cursor', 'border', 'font-weight', 'outline', 'color', 'border-radius',
                'min-height', 'width', 'align-items', 'margin-bottom',
                'font-size', 'margin-left', 'resize', 'margin-right', 'vertical-align'
            ];
            this.cssclasses = [
                'tabs-main', 'tabs-secondary', 'tabs-accent', 'tabs-muted', 'tabs-highlight',
                'tab-default', 'tab-active', 'tab-secondary', 'tab-danger', 'tab-info',
                'tabcontent-inactive', 'tabcontent-active', 'tabcontent-secondary', 'tabcontent-muted', 'tabcontent-highlight',
                'dropdown-root', 'dropdown-secondary', 'dropdown-accent', 'dropdown-muted', 'dropdown-highlight',
                'crudbtn-root', 'crudbtn-danger', 'crudbtn-success', 'crudbtn-info', 'crudbtn-muted',
                'textarea-root', 'textarea-secondary', 'textarea-accent', 'textarea-muted', 'textarea-highlight',
                'iconbtn-primary', 'iconbtn-secondary', 'iconbtn-danger', 'iconbtn-success', 'iconbtn-info',
                'todoarea-root', 'todoarea-secondary', 'todoarea-accent', 'todoarea-muted', 'todoarea-highlight'
            ];
            this.cssvalues = [
                // Tabs
                `flex,2px solid #ccc,#fafafa,0px,0px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl}`,
                `flex,2px solid #bbb,#f0f0f0,2px,2px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl}`,
                `flex,2px solid #09c,#eaf6ff,0px,0px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl}`,
                `flex,2px solid #eee,#f9f9f9,0px,0px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl}`,
                `flex,2px solid #f90,#fffbe6,0px,0px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl}`,
                // Tab Buttons
                `${this.nl},${this.nl},#f7f7f7,12px 24px,${this.nl},pointer,none,bold,none,#222,3px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl}`,
                `${this.nl},${this.nl},#fff,12px 24px,${this.nl},pointer,none,bold,none,#222,3px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl}`,
                `${this.nl},${this.nl},#e0e0e0,12px 24px,${this.nl},pointer,none,normal,none,#555,3px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl}`,
                `${this.nl},${this.nl},#ffdddd,12px 24px,${this.nl},pointer,none,bold,none,#a00,3px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl}`,
                `${this.nl},${this.nl},#ddeeff,12px 24px,${this.nl},pointer,none,normal,none,#036,3px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl}`,
                // Tab Content
                `none,${this.nl},#fff,24px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},0px,100%,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl}`,
                `block,${this.nl},#fff,24px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},0px,100%,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl}`,
                `block,${this.nl},#f7f7f7,16px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},0px,100%,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl}`,
                `block,${this.nl},#fafafa,8px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},0px,100%,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl}`,
                `block,${this.nl},#fffbe6,24px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},0px,100%,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},${this.nl}`,
                // Dropdown Editable
                `flex,${this.nl},#fff,0px,8px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},0px,${this.nl},${this.nl},center,16px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl}`,
                `flex,${this.nl},#f7f7f7,4px,8px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},2px,${this.nl},${this.nl},center,8px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl}`,
                `flex,${this.nl},#eaf6ff,8px,12px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},4px,${this.nl},${this.nl},center,12px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl}`,
                `flex,${this.nl},#fafafa,0px,4px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},0px,${this.nl},${this.nl},center,4px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl}`,
                `flex,${this.nl},#fffbe6,0px,8px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl},0px,${this.nl},${this.nl},center,16px,${this.nl},${this.nl},${this.nl},${this.nl},${this.nl}`,
                // CRUD Buttons
                `${this.nl},1px solid #ccc,#eee,2px 6px,${this.nl},pointer,${this.nl},#222,none,${this.nl},3px,${this.nl},${this.nl},${this.nl},2px,1em,${this.nl},${this.nl},${this.nl},${this.nl}`,
                `${this.nl},1px solid #f00,#ffdddd,2px 6px,${this.nl},pointer,${this.nl},#a00,none,${this.nl},3px,${this.nl},${this.nl},${this.nl},2px,1em,${this.nl},${this.nl},${this.nl},${this.nl}`,
                `${this.nl},1px solid #0a0,#e0ffe0,2px 6px,${this.nl},pointer,${this.nl},#070,none,${this.nl},3px,${this.nl},${this.nl},${this.nl},2px,1em,${this.nl},${this.nl},${this.nl},${this.nl}`,
                `${this.nl},1px solid #09c,#ddeeff,2px 6px,${this.nl},pointer,${this.nl},#036,none,${this.nl},3px,${this.nl},${this.nl},${this.nl},2px,1em,${this.nl},${this.nl},${this.nl},${this.nl}`,
                `${this.nl},1px solid #eee,#fafafa,2px 6px,${this.nl},pointer,${this.nl},#aaa,none,${this.nl},3px,${this.nl},${this.nl},${this.nl},2px,1em,${this.nl},${this.nl},${this.nl},${this.nl}`,
                // Textarea Large
                `${this.nl},1px solid #ccc,#fff,8px,${this.nl},${this.nl},4px,#222,${this.nl},${this.nl},4px,180px,100%,${this.nl},12px,1em,vertical,${this.nl},${this.nl},${this.nl}`,
                `${this.nl},1px solid #bbb,#f7f7f7,6px,${this.nl},${this.nl},4px,#333,${this.nl},${this.nl},4px,120px,100%,${this.nl},8px,0.9em,vertical,${this.nl},${this.nl},${this.nl}`,
                `${this.nl},1px solid #09c,#eaf6ff,10px,${this.nl},${this.nl},6px,#036,${this.nl},${this.nl},6px,220px,100%,${this.nl},16px,1.1em,vertical,${this.nl},${this.nl},${this.nl}`,
                `${this.nl},1px solid #eee,#fafafa,4px,${this.nl},${this.nl},2px,#aaa,${this.nl},${this.nl},2px,80px,100%,${this.nl},4px,0.8em,vertical,${this.nl},${this.nl},${this.nl}`,
                `${this.nl},1px solid #f90,#fffbe6,8px,${this.nl},${this.nl},4px,#a60,${this.nl},${this.nl},4px,200px,100%,${this.nl},10px,1em,vertical,${this.nl},${this.nl},${this.nl}`,
                // Icon Button Group
                `${this.nl},1px solid #bbb,#e0e0e0,4px 10px,${this.nl},pointer,${this.nl},#222,none,${this.nl},3px,${this.nl},${this.nl},${this.nl},${this.nl},1em,${this.nl},6px,middle,${this.nl}`,
                `${this.nl},1px solid #ccc,#f7f7f7,4px 10px,${this.nl},pointer,${this.nl},#555,none,${this.nl},3px,${this.nl},${this.nl},${this.nl},${this.nl},1em,${this.nl},6px,middle,${this.nl}`,
                `${this.nl},1px solid #f00,#ffdddd,4px 10px,${this.nl},pointer,${this.nl},#a00,none,${this.nl},3px,${this.nl},${this.nl},${this.nl},${this.nl},1em,${this.nl},6px,middle,${this.nl}`,
                `${this.nl},1px solid #0a0,#e0ffe0,4px 10px,${this.nl},pointer,${this.nl},#070,none,${this.nl},3px,${this.nl},${this.nl},${this.nl},${this.nl},1em,${this.nl},6px,middle,${this.nl}`,
                `${this.nl},1px solid #09c,#ddeeff,4px 10px,${this.nl},pointer,${this.nl},#036,none,${this.nl},3px,${this.nl},${this.nl},${this.nl},${this.nl},1em,${this.nl},6px,middle,${this.nl}`,
                // Todo Area
                `${this.nl},1px dashed #bbb,#f9f9f9,8px,${this.nl},${this.nl},4px,#aaa,${this.nl},${this.nl},4px,120px,100%,${this.nl},8px,1em,vertical,${this.nl},${this.nl},${this.nl}`,
                `${this.nl},1px dashed #eee,#fafafa,4px,${this.nl},${this.nl},2px,#bbb,${this.nl},${this.nl},2px,80px,100%,${this.nl},4px,0.9em,vertical,${this.nl},${this.nl},${this.nl}`,
                `${this.nl},1px solid #09c,#eaf6ff,12px,${this.nl},${this.nl},6px,#036,${this.nl},${this.nl},6px,160px,100%,${this.nl},12px,1.1em,vertical,${this.nl},${this.nl},${this.nl}`,
                `${this.nl},1px solid #eee,#fff,2px,${this.nl},${this.nl},1px,#aaa,${this.nl},${this.nl},1px,60px,100%,${this.nl},2px,0.8em,vertical,${this.nl},${this.nl},${this.nl}`,
                `${this.nl},1px solid #f90,#fffbe6,10px,${this.nl},${this.nl},4px,#a60,${this.nl},${this.nl},4px,140px,100%,${this.nl},10px,1em,vertical,${this.nl},${this.nl},${this.nl}`
            ];
            this.registerStyles();
        }
    }

    // Helper functions
    function createElements(tag, { cssclasses, getClassName }, isTextarea = false, ...texts) {
        return texts.map((text, i) => {
            const elem = window.CssManagement.DOMHandler.createElement(tag, {
                class: getClassName(cssclasses[i % cssclasses.length])
            });
            if (isTextarea) {
                elem.placeholder = text;
            } else {
                elem.textContent = text;
            }
            return elem;
        });
    }

    function appendAll(parent, children) {
        children.forEach(child => window.CssManagement.DOMHandler.appendChild(parent, child));
    }

    // Updated buildRootUI function
    function buildRootUI() {
        const DOMHandler = window.CssManagement.DOMHandler;
        // Clear body
        document.body.innerHTML = '';

        // Registry and centralized styles
        const registry = new window.CssManagement.StyleRegistry('storiumApp');
        const styleBody = new StyleBody(registry);

        // Tabs
        const tabsArr = createElements('button', {
            cssclasses: ['tab-default', 'tab-active', 'tab-secondary', 'tab-danger', 'tab-info'],
            getClassName: (cls) => styleBody.getClassName(cls)
        }, false, 'Storium', 'Table Builder', 'Extra 1', 'Extra 2', 'Extra 3');
        tabsArr.forEach((btn, i) => btn.setAttribute('data-tab', i));
        tabsArr[0].classList.add(styleBody.getClassName('tab-active'));
        const tabs = DOMHandler.createElement('div', { class: styleBody.getClassName('tabs-main') });
        appendAll(tabs, tabsArr);

        // Tab 1: Storium
        const tab1 = DOMHandler.createElement('div', { class: styleBody.getClassName('tabcontent-active'), id: 'tab1' });
        // Dropdown-editable
        const ddEdit = DOMHandler.createElement('div', { class: styleBody.getClassName('dropdown-root') });
        const label = DOMHandler.createElement('label', { htmlFor: 'gamesDropdown' });
        appendAll(label, [DOMHandler.createElement('b', { textContent: 'Games' })]);
        const gamesDropdown = DOMHandler.createElement('select', { id: 'gamesDropdown' });
        const crudBtns = createElements('button', {
            cssclasses: ['crudbtn-root', 'crudbtn-danger', 'crudbtn-success', 'crudbtn-info', 'crudbtn-muted'],
            getClassName: (cls) => styleBody.getClassName(cls)
        }, false, '＋', '🗑', '✎', '★', '…');
        crudBtns[0].title = 'Create Game';
        crudBtns[1].title = 'Remove Game';
        crudBtns[2].title = 'Update Game';
        crudBtns[3].title = 'Extra 1';
        crudBtns[4].title = 'Extra 2';
        appendAll(ddEdit, [label, gamesDropdown, ...crudBtns]);
        // TreeView
        const treeView = DOMHandler.createElement('div', { id: 'treeView' });
        appendAll(tab1, [ddEdit, treeView]);

        // ...existing code for tab2, event wiring, and app logic...
    }

    // ...rest of your app logic...

    // Expose for debugging if needed
    exports.StyleBody = StyleBody;
    exports.buildRootUI = buildRootUI;
});
        </script>
</body>
</html>

    function buildRootUI() {
        const DOMHandler = window.CssManagement.DOMHandler;
        // Clear body
        document.body.innerHTML = '';

        // Registry and components
        if (!registry) registry = new window.CssManagement.StyleRegistry('storiumApp');
        const styleBody = new StyleBody(registry);

        // Tabs (multiple at once)
    const tabsArr = createElements('button', { cssclasses: ['default', 'active', 'secondary', 'danger', 'info'], getClassName: (cls) => styleBody.getClassName('tab', cls) }, false, 'Storium', 'Table Builder', 'Extra 1', 'Extra 2', 'Extra 3');
    tabsArr.forEach((btn, i) => btn.setAttribute('data-tab', i));
    tabsArr[0].classList.add('active');
    const tabs = DOMHandler.createElement('div', { class: styleBody.getClassName('tabs', 'main') });
    appendAll(tabs, tabsArr);

        // Tab 1: Storium
    const tab1 = DOMHandler.createElement('div', { class: styleBody.getClassName('tabcontent', 'active'), id: 'tab1' });
        // Dropdown-editable (multiple at once)
    const ddEdit = DOMHandler.createElement('div', { class: styleBody.getClassName('dropdowneditable', 'root') });
        const label = DOMHandler.createElement('label', { htmlFor: 'gamesDropdown' });
        appendAll(label, [DOMHandler.createElement('b', { textContent: 'Games' })]);
        const gamesDropdown = DOMHandler.createElement('select', { id: 'gamesDropdown' });
    const crudBtns = createElements('button', { cssclasses: ['root', 'danger', 'success', 'info', 'muted'], getClassName: (cls) => styleBody.getClassName('crudbtn', cls) }, false, '＋', '🗑', '✎', '★', '…');
        crudBtns[0].title = 'Create Game';
        crudBtns[1].title = 'Remove Game';
        crudBtns[2].title = 'Update Game';
        crudBtns[3].title = 'Extra 1';
        crudBtns[4].title = 'Extra 2';
        appendAll(ddEdit, [label, gamesDropdown, ...crudBtns]);
        // TreeView
        const treeView = DOMHandler.createElement('div', { id: 'treeView' });
        appendAll(tab1, [ddEdit, treeView]);

        // Tab 2: Table Builder
    const tab2 = DOMHandler.createElement('div', { class: styleBody.getClassName('tabcontent', 'inactive'), id: 'tab2' });
        // Multiple textarea styles
        const textareas = createElements('textarea', { cssclasses: ['root', 'secondary', 'accent', 'muted', 'highlight'], getClassName: (cls) => styleBody.getClassName('textarealarge', cls) }, false,
            'Edit or paste table definitions here...',
            'Secondary textarea',
            'Accent textarea',
            'Muted textarea',
            'Highlight textarea');
        textareas[0].id = 'tableTextArea';
        // Icon button group (multiple at once)
        const btnRow = DOMHandler.createElement('div');
    const iconBtns = createElements('button', { cssclasses: ['primary', 'secondary', 'danger', 'success', 'info'], getClassName: (cls) => styleBody.getClassName('iconbtngroup', cls) }, false, '🔨 Build', '… Secondary', '⚠ Danger', '✔ Success', '⟳ Load from Tree');
        appendAll(btnRow, iconBtns);
        // Multiple todo areas
        const todos = createElements('textarea', { cssclasses: ['root', 'secondary', 'accent', 'muted', 'highlight'], getClassName: (cls) => styleBody.getClassName('todoarea', cls) }, true,
            'TODO: Area 2 (unimplemented)',
            'TODO: Area 3 (unimplemented)',
            'TODO: Area 4 (unimplemented)',
            'TODO: Area 5 (unimplemented)',
            'TODO: Area 6 (unimplemented)');
        appendAll(tab2, [...textareas, btnRow, ...todos]);

        // Append all to body
        appendAll(document.body, [tabs, tab1, tab2]);

        // Return references for wiring events (use first of each array for main logic)
        return {
            tabStorium: tabsArr[0],
            tabBuilder: tabsArr[1],
            tab1, tab2, gamesDropdown,
            btnCreate: crudBtns[0], btnRemove: crudBtns[1], btnUpdate: crudBtns[2],
            treeView,
            btnBuild: iconBtns[0], btnLoad: iconBtns[4], textarea: textareas[0],
            tabBtnComp, tabContentComp
        };
    }

    // ...existing code...

        // Load CssManagement library
        let CssManagementLoaded = false;
        function loadCssManagement(cb) {
            if (CssManagementLoaded) { cb(); return; }
            const script = document.createElement('script');
            script.src = 'https://raw.githubusercontent.com/Cava1ier/libraries/refs/heads/main/css/css-management.js';
            script.onload = function() { CssManagementLoaded = true; cb(); };
            document.head.appendChild(script);
        }

        // --- StoriumData: Data IIFE ---
        window.StoriumData = (function() {
            let state = {
                games: [], players: [], gameSettings: [], characters: [], playersCharacters: [], cardTypes: [], cards: [], charactersCards: [], scenes: [], sceneCharacters: [], conflicts: [], conflictPips: [], cardInstances: [], moves: [], goals: [], sceneGoals: [], assets: [], sceneAssets: [], subplots: [], subplotsProgress: [], hostActions: [], selectedGameIdx: 0
            };
            function parseTables(text) {
                const lines = text.split(/\r?\n/);
                let currentTable = null;
                let columns = [];
                let tables = {};
                for (let line of lines) {
                    line = line.trim();
                    if (!line || line.startsWith('//')) { currentTable = null; continue; }
                    if (line.startsWith('tbl') && line.includes(':')) {
                        const [tableName, colStr] = line.split(':');
                        columns = colStr.split('|').map(s => s.trim());
                        currentTable = tableName.trim();
                        tables[currentTable] = tables[currentTable] || [];
                        continue;
                    }
                    if (currentTable) {
                        const values = line.split('|').map(s => s.trim());
                        let row = {};
                        columns.forEach((col, i) => row[col] = values[i] !== undefined ? values[i] : null);
                        tables[currentTable].push(row);
                    }
                }
                return tables;
            }
            function buildDataModelFromTables(tables) {
                function int(v) { return v === undefined || v === null ? null : parseInt(v, 10); }
                state.games = (tables.tblGames||[]).map(r => ({ id: int(r.id), name: r.name, desc: r.desc }));
                state.players = (tables.tblPlayers||[]).map(r => ({ id: int(r.id), name: r.name }));
                state.gameSettings = (tables.tblGameSettings||[]).map(r => ({ id: int(r.id), game_id: int(r.game_id), key: r.setting_key, value: r.setting_value }));
                state.characters = (tables.tblCharacters||[]).map(r => ({ id: int(r.id), game_id: int(r.game_id), name: r.name, status: r.status, is_pc: r.is_pc === '1' }));
                state.playersCharacters = (tables.tblPlayersCharacters||[]).map(r => ({ id: int(r.id), player_id: int(r.player_id), character_id: int(r.character_id), is_primary: r.is_primary === '1' }));
                state.cardTypes = (tables.tblCardTypes||[]).map(r => ({ id: int(r.id), name: r.name, category: r.category, is_wild: r.is_wild === '1' }));
                state.cards = (tables.tblCards||[]).map(r => ({ id: int(r.id), game_id: int(r.game_id), name: r.name, desc: r.desc, card_type_id: int(r.card_type_id) }));
                state.charactersCards = (tables.tblCharactersCards||[]).map(r => ({ id: int(r.id), character_id: int(r.character_id), card_id: int(r.card_id), count: int(r.count) }));
                state.scenes = (tables.tblScenes||[]).map(r => ({ id: int(r.id), game_id: int(r.game_id), name: r.name, desc: r.desc, place_card_id: int(r.place_card_id), status: r.status, intro_narration: r.intro_narration }));
                state.sceneCharacters = (tables.tblSceneCharacters||[]).map(r => ({ id: int(r.id), scene_id: int(r.scene_id), character_id: int(r.character_id), is_npc: r.is_npc === '1' }));
                state.conflicts = (tables.tblConflicts||[]).map(r => ({ id: int(r.id), scene_id: int(r.scene_id), card_id: int(r.card_id), type: r.type, name: r.name, desc: r.desc, max_pips: int(r.max_pips), status: r.status }));
                state.conflictPips = (tables.tblConflictPips||[]).map(r => ({ id: int(r.id), conflict_id: int(r.conflict_id), pip_number: int(r.pip_number), assigned_character_id: int(r.assigned_character_id), assigned_card_instance_id: int(r.assigned_card_instance_id), outcome: r.outcome, narrative: r.narrative }));
                state.cardInstances = (tables.tblCardInstances||[]).map(r => ({ id: int(r.id), card_id: int(r.card_id), owner_character_id: int(r.owner_character_id), scene_id: int(r.scene_id), custom_name: r.custom_name, custom_desc: r.custom_desc, timestamp: r.timestamp, spent: r.spent === '1' }));
                state.moves = (tables.tblMoves||[]).map(r => ({ id: int(r.id), scene_id: int(r.scene_id), conflict_id: int(r.conflict_id), card_instance_id: int(r.card_instance_id), player_id: int(r.player_id), text: r.text, timestamp: r.timestamp }));
                state.goals = (tables.tblGoals||[]).map(r => ({ id: int(r.id), game_id: int(r.game_id), name: r.name, desc: r.desc }));
                state.sceneGoals = (tables.tblSceneGoals||[]).map(r => ({ id: int(r.id), scene_id: int(r.scene_id), goal_id: int(r.goal_id), assigned_character_id: int(r.assigned_character_id), status: r.status }));
                state.assets = (tables.tblAssets||[]).map(r => ({ id: int(r.id), game_id: int(r.game_id), name: r.name, desc: r.desc }));
                state.sceneAssets = (tables.tblSceneAssets||[]).map(r => ({ id: int(r.id), scene_id: int(r.scene_id), asset_id: int(r.asset_id), assigned_character_id: int(r.assigned_character_id), status: r.status }));
                state.subplots = (tables.tblSubplots||[]).map(r => ({ id: int(r.id), card_id: int(r.card_id), name: r.name, desc: r.desc }));
                state.subplotsProgress = (tables.tblSubplotsProgress||[]).map(r => ({ id: int(r.id), character_id: int(r.character_id), subplot_id: int(r.subplot_id), scene_id: int(r.scene_id), progress_note: r.progress_note, timestamp: r.timestamp }));
                state.hostActions = (tables.tblHostActions||[]).map(r => ({ id: int(r.id), scene_id: int(r.scene_id), action_type: r.action_type, details: r.details, timestamp: r.timestamp }));
            }
            // CRUD and accessors
            function getGames() { return state.games; }
            function getSelectedGameIdx() { return state.selectedGameIdx; }
            function setSelectedGameIdx(idx) { state.selectedGameIdx = idx; }
            function getPlayers() { return state.players; }
            function getGameSettings() { return state.gameSettings; }
            function getCharacters() { return state.characters; }
            function getScenes() { return state.scenes; }
            function createGame(name) {
                const newGame = { id: state.games.length ? Math.max(...state.games.map(g=>g.id||0))+1 : 1, name, desc: '', scenes: [] };
                state.games.push(newGame);
                state.selectedGameIdx = state.games.length - 1;
                return newGame;
            }
            function removeGame(idx) {
                if (state.games.length === 0) return;
                state.games.splice(idx, 1);
                state.selectedGameIdx = Math.max(0, state.selectedGameIdx - 1);
            }
            function updateGame(idx, name) {
                if (state.games.length === 0) return;
                state.games[idx].name = name;
            }
            function updateGameDesc(idx, desc) {
                if (state.games.length === 0) return;
                state.games[idx].desc = desc;
            }
            return {
                parseTables, buildDataModelFromTables, getGames, getSelectedGameIdx, setSelectedGameIdx, getPlayers, getGameSettings, getCharacters, getScenes, createGame, removeGame, updateGame, updateGameDesc,
                _state: state // for debugging
            };
        })();

        // --- StoriumUIX: UI IIFE ---
        window.StoriumUIX = (function() {
            // All UI rendering and event logic
            function renderGamesDropdown(games, selectedIdx) {
                const dd = document.getElementById('gamesDropdown');
                dd.innerHTML = '';
                games.forEach((g, i) => {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = g.name;
                    dd.appendChild(opt);
                });
                dd.selectedIndex = selectedIdx;
            }
            function renderTreeView(game, allData) {
                loadCssManagement(function() {
                    const DOMHandler = window.CssManagement.DOMHandler;
                    const container = document.getElementById('treeView');
                    container.innerHTML = '';
                    if (!game) return;

                    // Game Desc & Settings
                    const gameDesc = DOMHandler.createElement('div', { class: 'tree-item' });
                    appendAll(gameDesc, createManyElements('span', [
                        { class: 'tree-label', textContent: 'Desc:' },
                        { textContent: game.desc || '(none)' }
                    ]));
                    appendAll(gameDesc, [DOMHandler.createElement('button', { class: 'crud-btn', title: 'Edit Desc', 'data-action': 'editGameDesc', textContent: '✎' })]);
                    appendAll(container, [gameDesc]);

                    // Game Settings
                    const settings = allData.gameSettings.filter(s => s.game_id === game.id);
                    if (settings.length) {
                        const settingsDiv = DOMHandler.createElement('div', { class: 'tree-group' });
                        DOMHandler.appendChild(settingsDiv, DOMHandler.createElement('b', { textContent: 'Settings' }));
                        const ul = DOMHandler.createElement('ul', { style: 'margin:0 0 0 16px;' });
                        settings.forEach(s => {
                            const li = DOMHandler.createElement('li');
                            DOMHandler.appendChild(li, DOMHandler.createElement('span', { class: 'tree-label', textContent: s.key + ':' }));
                            DOMHandler.appendChild(li, document.createTextNode(' ' + s.value));
                            DOMHandler.appendChild(ul, li);
                        });
                        DOMHandler.appendChild(settingsDiv, ul);
                        DOMHandler.appendChild(container, settingsDiv);
                    }

                    // Players
                    const players = allData.players;
                    if (players.length) {
                        const playersDiv = DOMHandler.createElement('div', { class: 'tree-group' });
                        DOMHandler.appendChild(playersDiv, DOMHandler.createElement('b', { textContent: 'Players' }));
                        const ul = DOMHandler.createElement('ul', { style: 'margin:0 0 0 16px;' });
                        players.forEach(p => {
                            const li = DOMHandler.createElement('li', { textContent: p.name });
                            DOMHandler.appendChild(ul, li);
                        });
                        DOMHandler.appendChild(playersDiv, ul);
                        DOMHandler.appendChild(container, playersDiv);
                    }

                    // Scenes group
                    const scenes = allData.scenes.filter(s => s.game_id === game.id);
                    const sceneCharacters = allData.sceneCharacters;
                    const characters = allData.characters.filter(c => c.game_id === game.id);
                    const cardTypes = allData.cardTypes;
                    const cards = allData.cards.filter(c => c.game_id === game.id);
                    const conflicts = allData.conflicts;
                    const conflictPips = allData.conflictPips;
                    const cardInstances = allData.cardInstances;
                    const moves = allData.moves;
                    const goals = allData.goals.filter(g => g.game_id === game.id);
                    const sceneGoals = allData.sceneGoals;
                    const assets = allData.assets.filter(a => a.game_id === game.id);
                    const sceneAssets = allData.sceneAssets;

                    const scenesGroup = DOMHandler.createElement('div', { class: 'tree-group' });
                    DOMHandler.appendChild(scenesGroup, DOMHandler.createElement('b', { textContent: 'Scenes' }));
                    DOMHandler.appendChild(scenesGroup, DOMHandler.createElement('button', { class: 'crud-btn', title: 'Add Scene', 'data-action': 'addScene', textContent: '＋' }));
                    scenes.forEach((scene, si) => {
                        const sceneDiv = DOMHandler.createElement('div', { class: 'scene tree-group' });
                        // Scene header
                        const sceneHeader = DOMHandler.createElement('div', { class: 'tree-item' });
                        appendAll(sceneHeader, createManyElements('span', [
                            { class: 'tree-label', textContent: scene.name },
                            { style: 'font-size:0.9em;color:#888;', textContent: '[' + scene.status + ']' }
                        ]));
                        appendAll(sceneHeader, createManyElements('button', [
                            { class: 'crud-btn', title: 'Edit Scene', 'data-action': 'editScene', 'data-si': si, textContent: '✎' },
                            { class: 'crud-btn', title: 'Remove Scene', 'data-action': 'removeScene', 'data-si': si, textContent: '🗑' }
                        ]));
                        appendAll(sceneDiv, [sceneHeader]);
                        // Scene desc
                        const sceneDesc = DOMHandler.createElement('div', { class: 'desc tree-item' });
                        appendAll(sceneDesc, createManyElements('span', [
                            { class: 'tree-label', textContent: 'Desc:' },
                            { textContent: scene.desc || '(none)' }
                        ]));
                        appendAll(sceneDesc, [DOMHandler.createElement('button', { class: 'crud-btn', title: 'Edit Desc', 'data-action': 'editSceneDesc', 'data-si': si, textContent: '✎' })]);
                        appendAll(sceneDiv, [sceneDesc]);
                        // Pips
                        const pipsDiv = DOMHandler.createElement('div', { class: 'tree-item' });
                        DOMHandler.appendChild(pipsDiv, DOMHandler.createElement('span', { class: 'tree-label', textContent: 'Pips:' }));
                        DOMHandler.appendChild(pipsDiv, document.createTextNode((conflicts.filter(c=>c.scene_id===scene.id).reduce((acc,c)=>acc+(c.max_pips||0),0)).toString()));
                        DOMHandler.appendChild(sceneDiv, pipsDiv);

                        // Obstacles
                        renderGroupList({
                            groupLabel: 'Obstacles',
                            items: conflicts.filter(c=>c.scene_id===scene.id && c.type==='obstacle'),
                            itemRenderFn: (li, ob) => renderLiSpans(li, [
                                { class: 'tree-label', textContent: ob.name },
                                { style: 'color:#888;', textContent: `[${ob.status}${ob.outcome ? ', ' + ob.outcome : ''}]` }
                            ]),
                            sceneDiv
                        });

                        // Character Conflicts
                        renderGroupList({
                            groupLabel: 'Character Conflicts',
                            items: conflicts.filter(c=>c.scene_id===scene.id && c.type==='character'),
                            itemRenderFn: (li, ob) => renderLiSpans(li, [
                                { class: 'tree-label', textContent: ob.name },
                                { style: 'color:#888;', textContent: `[${ob.status}${ob.outcome ? ', ' + ob.outcome : ''}]` }
                            ]),
                            sceneDiv
                        });

                        // Scene Characters
                        renderGroupList({
                            groupLabel: 'Scene Characters',
                            items: sceneCharacters.filter(sc=>sc.scene_id===scene.id),
                            itemRenderFn: (li, sc) => {
                                const char = characters.find(c=>c.id===sc.character_id);
                                renderLiSpans(li, [
                                    { class: 'tree-label', textContent: char ? char.name : '' }
                                ]);
                            },
                            sceneDiv
                        });

                        // Goals
                        renderGroupList({
                            groupLabel: 'Goals',
                            items: sceneGoals.filter(g=>g.scene_id===scene.id),
                            itemRenderFn: (li, goal) => {
                                const g = goals.find(x=>x.id===goal.goal_id);
                                renderLiSpans(li, [
                                    { class: 'tree-label', textContent: g ? g.name : '' },
                                    { style: 'color:#888;', textContent: `[${goal.status}]` }
                                ]);
                            },
                            sceneDiv
                        });

                        // Assets
                        renderGroupList({
                            groupLabel: 'Assets',
                            items: sceneAssets.filter(a=>a.scene_id===scene.id),
                            itemRenderFn: (li, asset) => {
                                const a = assets.find(x=>x.id===asset.asset_id);
                                renderLiSpans(li, [
                                    { class: 'tree-label', textContent: a ? a.name : '' },
                                    { style: 'color:#888;', textContent: `[${asset.status}]` }
                                ]);
                            },
                            sceneDiv
                        });

                        // Moves
                        renderGroupList({
                            groupLabel: 'Moves',
                            items: moves.filter(m=>m.scene_id===scene.id),
                            itemRenderFn: (li, move) => {
                                const char = characters.find(c=>c.id===cardInstances.find(ci=>ci.id===move.card_instance_id)?.owner_character_id);
                                renderLiSpanAndText(li, { class: 'tree-label', textContent: char ? char.name : '' }, ': ' + move.text);
                            },
                            sceneDiv
                        });

                        DOMHandler.appendChild(scenesGroup, sceneDiv);
                    });
                    DOMHandler.appendChild(container, scenesGroup);
                });
            }
            return {
                renderGamesDropdown,
                renderTreeView
            };
        })();

        // --- StoriumService: Service/Traffic IIFE ---
        window.StoriumService = (function() {
            const Data = window.StoriumData;
            const UIX = window.StoriumUIX;
            // Example: wire up dropdown
            function updateGamesDropdown() {
                UIX.renderGamesDropdown(Data.getGames(), Data.getSelectedGameIdx());
            }
            function updateTreeView() {
                const games = Data.getGames();
                const idx = Data.getSelectedGameIdx();
                UIX.renderTreeView(games[idx], {
                    players: Data.getPlayers(),
                    gameSettings: Data.getGameSettings(),
                    characters: Data.getCharacters(),
                    scenes: Data.getScenes(),
                    cardTypes: Data._state.cardTypes,
                    cards: Data._state.cards,
                    conflicts: Data._state.conflicts,
                    conflictPips: Data._state.conflictPips,
                    cardInstances: Data._state.cardInstances,
                    moves: Data._state.moves,
                    goals: Data._state.goals,
                    sceneGoals: Data._state.sceneGoals,
                    assets: Data._state.assets,
                    sceneAssets: Data._state.sceneAssets,
                    subplots: Data._state.subplots,
                    subplotsProgress: Data._state.subplotsProgress,
                    hostActions: Data._state.hostActions,
                });
            }
            // Example: create game
            function createGame() {
                const name = prompt("Game name?");
                if (!name) return;
                Data.createGame(name);
                updateGamesDropdown();
                updateTreeView();
            }
            // ...other service/traffic logic...
            return {
                updateGamesDropdown,
                updateTreeView,
                createGame
            };
        })();

    // --- Wire up UI and events using the new modular IIFEs and DOMHandler ---
    function showTab(idx, refs) {
        [refs.tabStorium, refs.tabBuilder].forEach((t, i) => t.classList.toggle('active', i === idx));
        [refs.tab1, refs.tab2].forEach((c, i) => c.classList.toggle('active', i === idx));
        if (idx === 0) window.StoriumService.updateTreeView();
    }

    function wireEvents(refs) {
        // Tabs
        refs.tabStorium.addEventListener('click', function() { showTab(0, refs); });
        refs.tabBuilder.addEventListener('click', function() { showTab(1, refs); });
        // Games dropdown
        refs.gamesDropdown.onchange = function() {
            window.StoriumData.setSelectedGameIdx(this.selectedIndex);
            window.StoriumService.updateTreeView();
        };
        // CRUD buttons
        refs.btnCreate.onclick = window.StoriumService.createGame;
        // (Remove and update game can be added to service as needed)
        // Table Builder
        refs.btnBuild.onclick = function() {
            const text = refs.textarea.value;
            const tables = window.StoriumData.parseTables(text);
            window.StoriumData.buildDataModelFromTables(tables);
            if (window.StoriumData.getGames().length > 0) window.StoriumData.setSelectedGameIdx(0);
            window.StoriumService.updateGamesDropdown();
            window.StoriumService.updateTreeView();
        };
        refs.btnLoad.onclick = function() {
            alert('Load from Tree (not implemented)');
        };
    }

    window.addEventListener('DOMContentLoaded', function() {
        loadCssManagement(function() {
            // Build root UI
            const refs = buildRootUI();
            // Wire up events
            wireEvents(refs);
            // Initial render
            window.StoriumService.updateGamesDropdown();
            window.StoriumService.updateTreeView();
        });
    });
